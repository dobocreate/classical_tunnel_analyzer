# Claude.md - プロジェクト開発履歴と技術仕様

## プロジェクト概要
村山式トンネル安定性解析システムの開発プロジェクト。Streamlitを使用したWebアプリケーションとして実装。

## 最新の変更点（2025年7月9日）

### 1. アルゴリズムの改良
- docs/murayama_gemini.mdの仕様に基づき、改良版村山式アルゴリズムを実装
- 対数らせんすべり面の厳密な幾何学的計算を導入
- SciPyのfsolveを使用した非線形方程式の解法

### 2. パラメータの変更
- `r0`（初期半径）を`tunnel_depth`（土被り）に変更
- `sigma_v`（地表面の上載荷重）を削除（計算の簡素化のため）
- `n_divisions`をUIから削除（内部で固定値として使用）

### 3. 上載荷重計算方法の選択機能
- 簡易法：土被り分の重量を計算
- テルツァギーの土圧理論：アーチング効果を考慮した計算

### 4. 反復計算の可視化
- リアルタイムプログレスバーとステータス表示
- 収束履歴グラフ（誤差の推移を対数スケールで表示）
- 収束統計情報（成功率、反復回数など）

### 5. UIの改善
- 水圧入力をトンネル諸元セクションに移動
- 荷重条件セクションを削除
- 条件入力と計算結果のセクション比率を1:1に変更
- 計算実行ボタンを押した時のみ計算を実行

## 技術スタック
- **フロントエンド**: Streamlit 1.35.0+
- **計算エンジン**: NumPy, SciPy
- **グラフ描画**: Plotly
- **データ検証**: Pydantic
- **PDFレポート**: ReportLab

## ファイル構成
```
classical_tunnel_analyzer/
├── app.py                    # メインアプリケーション
├── src/
│   ├── murayama_new.py      # 改良版村山式計算エンジン
│   ├── models.py            # データモデル定義
│   ├── convergence_utils.py # 収束計算の可視化ユーティリティ
│   └── report_generator.py  # レポート生成
├── docs/
│   ├── murayama_gemini.md   # アルゴリズム仕様書
│   └── テルツァギーの土圧理論.md
└── requirements.txt
```

## 計算手順
1. **入力パラメータの設定**
   - トンネル諸元（高さH、土被りD_t、水圧u）
   - 地山物性値（単位体積重量γ、粘着力c、内部摩擦角φ）
   - 詳細設定（探索範囲、反復計算パラメータ）

2. **すべり面探索**
   - x_startからx_endまでx_stepごとに探索
   - 各位置で対数らせんすべり面の形状を決定
   - 幾何学的拘束条件を満たす解をfsolveで探索

3. **支保圧力計算**
   - すべり土塊の重量と上載荷重を計算
   - モーメントの釣り合いから必要支保圧力Pを算出
   - 最大値P_maxと危険すべり面位置x_criticalを特定

4. **結果の評価**
   - P < 50 kN/m²: 切羽は安定
   - 50 ≤ P < 100 kN/m²: 軽微な支保が必要
   - P ≥ 100 kN/m²: 強固な支保が必要

## 既知の問題と対策
1. **詳細設定パラメータのスコープ問題**
   - expanderの外でデフォルト値を事前定義することで解決

2. **ZeroDivisionError**
   - 収束率計算時の分母チェックを追加

3. **レポート生成のAttributeError**
   - 古いパラメータ名（r0、sigma_v）の参照を更新

## 今後の開発予定
- [ ] 3次元解析への拡張
- [ ] より詳細な地盤モデルの実装
- [ ] 施工ステップを考慮した解析
- [ ] 実測データとの比較検証機能

## コマンドメモ
```bash
# ローカル実行
streamlit run app.py

# テスト実行
pytest tests/

# リンター実行
flake8 src/ --max-line-length=100

# 型チェック
mypy src/ --ignore-missing-imports
```

## 重要な設計判断
1. **上載荷重の簡素化**
   - 地表面の上載荷重（σ_v）を削除し、土被りによる荷重のみを考慮
   - テルツァギーの土圧理論オプションでアーチング効果を考慮可能

2. **反復計算の可視化**
   - アニメーションから進捗バーと統計情報表示に変更
   - 計算の数値的側面を重視した表示方式

3. **パラメータの最適化**
   - n_divisionsをUIから削除（内部で100に固定）
   - max_iterationsとtoleranceは詳細設定で調整可能

## デプロイメント
- Streamlit Cloudでホスティング
- GitHubリポジトリ: https://github.com/dobocreate/classical_tunnel_analyzer